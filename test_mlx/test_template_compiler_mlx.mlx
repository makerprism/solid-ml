
module Hello (Env : Solid_ml_template_runtime.Env_intf.TEMPLATE_ENV) = struct
  open Env

  module Html = Env.Html
  open Html

  let _ = empty

  let render_div ~name () =
    <div>
      (Tpl.text (fun () -> Signal.get name))
    </div>

  let render_div_once ~name () =
    <div>
      (Tpl.text_once (fun () -> name))
    </div>

  let render_div_props ~name () =
    <div id="root" class_="c1 c2">
      (Tpl.text (fun () -> Signal.get name))
    </div>

  let render_span ~name () =
    <span>
      (Tpl.text (fun () -> Signal.get name))
    </span>

  let render_p ~name () =
    <p>
      (Tpl.text (fun () -> Signal.get name))
    </p>

  let render_p_static ~name () =
    <p>
      (text "Hello ")
      (Tpl.text (fun () -> Signal.get name))
      (text "!")
    </p>

  let render_p_formatting ~name () =
    <p>
      (text "\n  ")
      (text "Hello ")
      (Tpl.text (fun () -> Signal.get name))
      (text "!")
      (text "\n")
    </p>

  let render_p_space ~name () =
    <p>
      (text " ")
      (Tpl.text (fun () -> Signal.get name))
    </p>

  let render_p_double_space ~name () =
    <p>
      (text "  ")
      (Tpl.text (fun () -> Signal.get name))
    </p>

  let render_p_tab_formatting ~name () =
    <p>
      (text "\t")
      (text "Hello ")
      (Tpl.text (fun () -> Signal.get name))
    </p>

  let render_pre_formatting ~name () =
    <pre>
      (text "\n  ")
      (Tpl.text (fun () -> Signal.get name))
      (text "\n")
    </pre>

  let render_code_formatting ~name () =
    <code>
      (text "\n  ")
      (Tpl.text (fun () -> Signal.get name))
      (text "\n")
    </code>

  let render_p_two_slots ~first ~last () =
    <p>
      (text "Hello ")
      (Tpl.text (fun () -> Signal.get first))
      (text ", ")
      (Tpl.text (fun () -> Signal.get last))
      (text "!")
    </p>

  let render_adjacent_nodes () =
    <div>
      (Tpl.nodes (fun () -> Html.text "A"))
      (Tpl.nodes (fun () -> Html.text "B"))
    </div>

  let render_adjacent_nodes_fragment () =
    <div>
      (Tpl.nodes (fun () -> Html.fragment [ Html.text "A"; Html.text "B" ]))
      (Tpl.nodes (fun () -> Html.text "C"))
    </div>

  let render_if_child ~show () =
    <div>
      (if show then Html.text "Shown" else Html.empty)
    </div>

  let render_numeric_children () =
    <div>
      (Html.int 42)
      (Html.float 3.5)
    </div>

  let child_factory () =
    <span>(Html.text "From factory")</span>

  let render_dynamic_with_child_factory () =
    <div onclick=(fun _ -> ())>
      (child_factory ())
    </div>

  let render_dynamic_with_if_child ~show () =
    <div onclick=(fun _ -> ())>
      (if show then <span>(Html.text "Shown")</span> else Html.empty)
    </div>
end

let () =
  print_endline "Test: Template PPX compiles Tpl.text (MLX)";
  let html =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_div ~name ())
  in
  assert (html = "<div><!--#-->World<!--#--></div>");

  let html_props =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_div_props ~name ())
  in
  assert (html_props = "<div id=\"root\" class=\"c1 c2\"><!--#-->World<!--#--></div>");

  let html_div_once =
    Solid_ml_ssr.Render.to_string (fun () ->
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_div_once ~name:"Once" ())
  in
  assert (html_div_once = "<div><!--#-->Once<!--#--></div>");

  let html_span =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_span ~name ())
  in
  assert (html_span = "<span><!--#-->World<!--#--></span>");

  let html_p =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_p ~name ())
  in
  assert (html_p = "<p><!--#-->World<!--#--></p>");

  let html_p_static =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_p_static ~name ())
  in
  assert (html_p_static = "<p>Hello <!--#-->World<!--#-->!</p>");

  let html_p_formatting =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_p_formatting ~name ())
  in
  assert (html_p_formatting = "<p>Hello <!--#-->World<!--#-->!</p>");

  let html_p_space =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_p_space ~name ())
  in
  assert (html_p_space = "<p> <!--#-->World<!--#--></p>");

  let html_p_double_space =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_p_double_space ~name ())
  in
  assert (html_p_double_space = "<p>  <!--#-->World<!--#--></p>");

  let html_p_tab_formatting =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_p_tab_formatting ~name ())
  in
  assert (html_p_tab_formatting = "<p>Hello <!--#-->World<!--#--></p>");

  let html_pre_formatting =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_pre_formatting ~name ())
  in
  assert (html_pre_formatting = "<pre>\n  <!--#-->World<!--#-->\n</pre>");

  let html_code_formatting =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_code_formatting ~name ())
  in
  assert (html_code_formatting = "<code>\n  <!--#-->World<!--#-->\n</code>");

  let html_p_two =
    Solid_ml_ssr.Render.to_string (fun () ->
      let first, _set_first = Solid_ml_server.Signal.Unsafe.create "Ada" in
      let last, _set_last = Solid_ml_server.Signal.Unsafe.create "Lovelace" in
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_p_two_slots ~first ~last ())
  in
  assert (html_p_two = "<p>Hello <!--#-->Ada<!--#-->, <!--#-->Lovelace<!--#-->!</p>");

  let html_adjacent_nodes =
    Solid_ml_ssr.Render.to_string (fun () ->
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_adjacent_nodes ())
  in
  assert (html_adjacent_nodes = "<div><!--$-->A<!--$--><!--$-->B<!--$--></div>");

  let html_adjacent_nodes_fragment =
    Solid_ml_ssr.Render.to_string (fun () ->
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_adjacent_nodes_fragment ())
  in
  assert (html_adjacent_nodes_fragment = "<div><!--$-->AB<!--$--><!--$-->C<!--$--></div>");

  let html_if_child_true =
    Solid_ml_ssr.Render.to_string (fun () ->
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_if_child ~show:true ())
  in
  assert (html_if_child_true = "<div>Shown</div>");

  let html_if_child_false =
    Solid_ml_ssr.Render.to_string (fun () ->
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_if_child ~show:false ())
  in
  assert (html_if_child_false = "<div></div>");

  let html_numeric_children =
    Solid_ml_ssr.Render.to_string (fun () ->
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_numeric_children ())
  in
  assert (html_numeric_children = "<div>423.5</div>");

  let html_dynamic_with_child_factory =
    Solid_ml_ssr.Render.to_string (fun () ->
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_dynamic_with_child_factory ())
  in
  assert (html_dynamic_with_child_factory = "<div><!--$--><span>From factory</span><!--$--></div>");

  let html_dynamic_if_child_true =
    Solid_ml_ssr.Render.to_string (fun () ->
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_dynamic_with_if_child ~show:true ())
  in
  assert (html_dynamic_if_child_true = "<div><!--$--><span>Shown</span><!--$--></div>");

  let html_dynamic_if_child_false =
    Solid_ml_ssr.Render.to_string (fun () ->
      let module C = Hello (Solid_ml_ssr.Env) in
      C.render_dynamic_with_if_child ~show:false ())
  in
  assert (html_dynamic_if_child_false = "<div><!--$--><!--$--></div>");

  print_endline "  PASSED"
