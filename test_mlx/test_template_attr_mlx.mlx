
module C (Env : Solid_ml_template_runtime.Env_intf.TEMPLATE_ENV) = struct
  open Env

  module Html = Env.Html
  open Html

  let _ = empty

  let render_a_some ~name () =
    <a href=(Tpl.attr_opt ~name:"href" (fun () -> Some "/x?y=<z>"))>
      (text "Go ")
      (Tpl.text (fun () -> Signal.get name))
    </a>

  let render_a_none ~name () =
    <a href=(Tpl.attr_opt ~name:"href" (fun () -> None))>
      (text "Go ")
      (Tpl.text (fun () -> Signal.get name))
    </a>

  let render_a_attr ~href ~name () =
    <a href=(Tpl.attr ~name:"href" (fun () -> Signal.get href))>
      (text "Go ")
      (Tpl.text (fun () -> Signal.get name))
    </a>
end

let () =
  print_endline "Test: Template PPX compiles Tpl.attr_opt (MLX)";
  let some_html =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let module R = C (Solid_ml_ssr.Env) in
      R.render_a_some ~name ())
  in
  assert (some_html = "<a href=\"/x?y=&lt;z&gt;\">Go <!--#-->World<!--#--></a>");

  let none_html =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let module R = C (Solid_ml_ssr.Env) in
      R.render_a_none ~name ())
  in
  assert (none_html = "<a>Go <!--#-->World<!--#--></a>");

  let attr_html =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let href, _set_href = Solid_ml_server.Signal.Unsafe.create "/x?y=<z>" in
      let module R = C (Solid_ml_ssr.Env) in
      R.render_a_attr ~href ~name ())
  in
  assert (attr_html = "<a href=\"/x?y=&lt;z&gt;\">Go <!--#-->World<!--#--></a>");

  let empty_html =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let empty_href, _set_empty_href = Solid_ml_server.Signal.Unsafe.create "" in
      let module R = C (Solid_ml_ssr.Env) in
      R.render_a_attr ~href:empty_href ~name ())
  in
  assert (empty_html = "<a href=\"\">Go <!--#-->World<!--#--></a>");

  let nested_html =
    Solid_ml_ssr.Render.to_string (fun () ->
      let name, _set_name = Solid_ml_server.Signal.Unsafe.create "World" in
      let module R = C (Solid_ml_ssr.Env) in
      Solid_ml_ssr.Html.div ~children:[ R.render_a_some ~name () ] ())
  in
  assert (nested_html = "<div><a href=\"/x?y=&lt;z&gt;\">Go <!--#-->World<!--#--></a></div>");

  print_endline "  PASSED"
